<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIFT Financial Report</title>
    
    <!-- Dynamic Favicon Links (Will be updated by JS) -->
    <link rel="icon" href="data:,">
    <link rel="apple-touch-icon" href="data:,">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts for Churchy Effect -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* Typography overrides for Church aesthetic */
        .font-church-heading { font-family: 'Cinzel', serif; }
        .font-church-sub { font-family: 'Playfair Display', serif; }
        .font-church-body { font-family: 'Lato', sans-serif; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* PRINT STYLES - CRITICAL FOR DATA VISIBILITY */
        @media print {
            @page { margin: 0.5cm; size: auto; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            
            /* Hide the main app root during print */
            #root { display: none !important; }
            
            /* Show the print root */
            #print-root { 
                display: block !important; 
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                z-index: 9999;
            }
            
            /* Hide screen-only buttons (Print Again/Close) on paper */
            .screen-only { display: none !important; }
        }
        
        /* On screen, hide the print root unless it has content (handled by React) */
        #print-root { 
            display: none; /* Hidden by default on screen, React will show it via Portal */
        }
        #print-root:not(:empty) {
            display: block;
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            overflow-y: auto;
        }

        /* Splash Screen Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 1.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-church-body">
    <!-- Main App Mount Point -->
    <div id="root"></div>
    
    <!-- Dedicated Print Mount Point -->
    <div id="print-root"></div>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        // It will look like: const firebaseConfig = { apiKey: "...", ... };
        const firebaseConfig = {
  apiKey: "AIzaSyA35XHx_Ar_F2amnn8LlMCuuTOLovO8ilk",
  authDomain: "shift-system-4f00b.firebaseapp.com",
  projectId: "shift-system-4f00b",
  storageBucket: "shift-system-4f00b.firebasestorage.app",
  messagingSenderId: "190445401565",
  appId: "1:190445401565:web:6405bf40d236c55dd23234"
};
        // ---------------------------------------

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                // Expose Firestore functions to global scope for the React app
                window.fs = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc };
                
                console.log("Firebase initialized successfully");
                
                // Sign in anonymously to allow database access (if rules allow request.auth != null)
                signInAnonymously(window.auth).then(() => {
                    console.log("Signed in to Firebase anonymously");
                }).catch((error) => {
                    console.error("Firebase Auth Error:", error);
                });
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
            }
        } else {
            console.log("No Firebase config found. Running in LocalStorage mode.");
        }
    </script>

    <script type="text/babel">
        window.addEventListener('load', () => {
            if (typeof Recharts === 'undefined') {
                document.getElementById('root').innerHTML = '<div class="p-8 text-center text-red-600 font-bold">Error: Charting library failed to load. Please refresh.</div>';
                return;
            }

            const { useState, useEffect, useMemo, useRef } = React;
            const { createPortal } = ReactDOM;
            const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer, LineChart, Line } = Recharts;

            // --- Icons ---
            const IconBase = ({ children, size = 24, className = "", style = {} }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>{children}</svg>
            );
            const LayoutDashboard = (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
            const PlusCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconBase>;
            const FileText = (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></IconBase>;
            const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
            const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
            const Save = (p) => <IconBase {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>;
            const Filter = (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
            const DollarSign = (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
            const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
            const TrendingDown = (p) => <IconBase {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
            const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
            const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
            const ChevronUp = (p) => <IconBase {...p}><path d="m18 15-6-6-6 6"/></IconBase>;
            const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
            const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
            const ImageIcon = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
            const Palette = (p) => <IconBase {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>;
            const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
            const CalculatorIcon = (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
            const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
            const Pencil = (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>;
            const Banknote = (p) => <IconBase {...p}><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></IconBase>;
            const Wallet = (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>;
            const Printer = (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>;
            const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
            const EyeOff = (p) => <IconBase {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
            const Cross = (p) => <IconBase {...p}><path d="M11 2a2 2 0 0 0-2 2v5H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h4v3a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3h4a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-4V4a2 2 0 0 0-2-2h-2z" /></IconBase>;
            const LogOut = (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
            const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
            const Cloud = (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19H2c0-5.523 4.477-10 10-10 .473 0 .937.034 1.39.1C13.882 4.12 18.397 1 23 6c0 5.523-4.477 10-10 10h-4.5"/></IconBase>;
            const CloudOff = (p) => <IconBase {...p}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8a5 5 0 0 0 1.8 9h5.6"/><line x1="1" x2="23" y1="1" y2="23"/></IconBase>;
            const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;

            // --- Helper Functions ---
            const formatNumberString = (val) => {
                if (val === '' || val === undefined || val === null) return '';
                const num = val.toString().replace(/,/g, '');
                if (isNaN(num)) return val;
                return num.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            };
            const formatCurrency = (amt, curr) => new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(Number(amt) || 0);
            const getSymbol = (c) => c === 'LAK' ? '₭' : c === 'USD' ? '$' : c === 'THB' ? '฿' : '';
            const safeNum = (val) => {
                if (typeof val === 'string') return Number(val.replace(/,/g, '')) || 0;
                return Number(val) || 0;
            };
            
            const applyFavicon = (url) => {
                if (!url) return;
                let link = document.querySelector("link[rel~='icon']");
                if (!link) {
                    link = document.createElement('link');
                    link.rel = 'icon';
                    document.head.appendChild(link);
                }
                link.href = url;
                
                let appleLink = document.querySelector("link[rel~='apple-touch-icon']");
                if (!appleLink) {
                    appleLink = document.createElement('link');
                    appleLink.rel = 'apple-touch-icon';
                    document.head.appendChild(appleLink);
                }
                appleLink.href = url;
            };

            // --- Components ---
            const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;
            const Button = ({ children, onClick, variant = "primary", className = "", type = "button", style = {} }) => {
                const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
                const variants = {
                    primary: "text-white shadow-md active:opacity-90 hover:opacity-90",
                    secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200",
                    danger: "bg-red-50 text-red-600 hover:bg-red-100",
                    outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
                    ghost: "bg-transparent text-slate-600 hover:bg-slate-50"
                };
                const appliedClass = variant === 'primary' ? `${baseStyle} ${variants.primary} ${className}` : `${baseStyle} ${variants[variant]} ${className}`;
                return <button type={type} onClick={onClick} className={appliedClass} style={variant === 'primary' ? style : {}}>{children}</button>;
            };

            // --- SPLASH SCREEN COMPONENT ---
            const SplashScreen = ({ onComplete, customLogo }) => {
                const [progress, setProgress] = useState(0);

                useEffect(() => {
                    const timer = setInterval(() => {
                        setProgress(prev => {
                            if (prev >= 100) {
                                clearInterval(timer);
                                setTimeout(onComplete, 500); 
                                return 100;
                            }
                            return prev + Math.floor(Math.random() * 5) + 1;
                        });
                    }, 50);
                    return () => clearInterval(timer);
                }, [onComplete]);

                return (
                    <div className="fixed inset-0 bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex flex-col items-center justify-center z-[100] text-white">
                        <div className="text-center animate-fade-in px-4">
                            <div className="mb-6 flex justify-center">
                                {customLogo ? (
                                    <div className="w-40 h-40 flex items-center justify-center mb-4">
                                        <img src={customLogo} alt="Logo" className="w-full h-full object-contain drop-shadow-[0_0_15px_rgba(234,179,8,0.5)]" />
                                    </div>
                                ) : (
                                    <div className="bg-yellow-500/20 p-6 rounded-full border-2 border-yellow-500 shadow-[0_0_30px_rgba(234,179,8,0.5)]">
                                        <Cross size={64} className="text-yellow-400" />
                                    </div>
                                )}
                            </div>
                            <h1 className="font-church-heading text-4xl md:text-5xl font-bold tracking-wider text-yellow-500 mb-2 drop-shadow-md">SHIFT</h1>
                            <h2 className="font-church-sub text-xl md:text-2xl text-slate-200 italic mb-8 font-light">The Shepherd's House Fellowship of Teachers</h2>
                            
                            <div className="w-full max-w-md bg-slate-800/50 rounded-full h-3 mb-4 mx-auto border border-slate-700 overflow-hidden relative">
                                <div 
                                    className="bg-gradient-to-r from-yellow-600 via-yellow-400 to-yellow-600 h-full rounded-full transition-all duration-75 ease-out shadow-[0_0_10px_rgba(234,179,8,0.8)]"
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>
                            <div className="text-slate-400 text-sm font-church-body tracking-widest uppercase">
                                Loading Financial System... {Math.min(100, progress)}%
                            </div>
                        </div>
                        <div className="absolute bottom-8 text-slate-500 text-xs font-church-body opacity-50">
                            Serving with Integrity & Excellence
                        </div>
                    </div>
                );
            };

            // --- LOGIN PAGE COMPONENT ---
            const LoginPage = ({ onLogin }) => {
                const [username, setUsername] = useState('');
                const [password, setPassword] = useState('');
                const [error, setError] = useState('');
                const [showPassword, setShowPassword] = useState(false);
                const [rememberMe, setRememberMe] = useState(false);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (username === 'SHIFT' && password === 'shift2025') {
                        onLogin(rememberMe);
                    } else {
                        setError('Invalid Username or Password');
                        setPassword('');
                    }
                };
                
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png')] relative">
                        <div className="max-w-md w-full bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200 z-0">
                            <div className="bg-gradient-to-r from-blue-900 to-slate-900 p-8 text-center border-b-4 border-yellow-500">
                                <div className="mx-auto bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mb-4 border border-white/20">
                                    <Cross size={32} className="text-yellow-400" />
                                </div>
                                <h1 className="font-church-heading text-3xl font-bold text-white mb-1">Welcome</h1>
                                <p className="font-church-sub text-blue-200 italic">Please sign in to continue</p>
                            </div>
                            
                            <div className="p-8">
                                <form onSubmit={handleSubmit} className="space-y-6">
                                    {error && (
                                        <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2 border border-red-100">
                                            <AlertCircle size={16} /> {error}
                                        </div>
                                    )}
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-slate-600 mb-2 font-church-body uppercase tracking-wider">Username</label>
                                        <input 
                                            type="text" 
                                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent outline-none transition-all"
                                            value={username}
                                            onChange={(e) => setUsername(e.target.value)}
                                            placeholder="Enter ID"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-slate-600 mb-2 font-church-body uppercase tracking-wider">Password</label>
                                        <div className="relative">
                                            <input 
                                                type={showPassword ? "text" : "password"}
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent outline-none transition-all pr-10"
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                placeholder="••••••••"
                                            />
                                            <button 
                                                type="button" 
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-3 top-3.5 text-slate-400 hover:text-slate-600"
                                            >
                                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            id="rememberMe" 
                                            className="w-4 h-4 text-blue-900 border-gray-300 rounded focus:ring-blue-900"
                                            checked={rememberMe}
                                            onChange={(e) => setRememberMe(e.target.checked)}
                                        />
                                        <label htmlFor="rememberMe" className="ml-2 block text-sm text-slate-600">
                                            Remember me
                                        </label>
                                    </div>

                                    <button 
                                        type="submit" 
                                        className="w-full bg-blue-900 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition-colors shadow-lg active:scale-[0.98] font-church-body uppercase tracking-widest"
                                    >
                                        Access System
                                    </button>
                                </form>
                            </div>
                            <div className="bg-slate-50 p-4 text-center border-t border-slate-100">
                                <p className="text-xs text-slate-400 font-church-sub italic">Restricted Access • SHIFT Financial System</p>
                            </div>
                        </div>
                        
                        <div className="mt-8 text-center text-slate-400 text-xs font-church-body">
                            &copy; {new Date().getFullYear()} SHIFT. All rights reserved.
                        </div>
                    </div>
                );
            };

            // --- Print Layout Component (PORTAL) ---
            const PrintLayout = ({ data, type, logo, themeColor, onClose }) => {
                const date = new Date().toLocaleDateString();
                
                useEffect(() => {
                    const timer = setTimeout(() => window.print(), 500);
                    return () => clearTimeout(timer);
                }, []);

                const content = (
                    <div className="bg-white p-8 text-black min-h-screen relative font-sans">
                        <div className="screen-only fixed top-4 right-4 flex gap-2 bg-white/90 backdrop-blur p-2 rounded shadow-lg border border-slate-200 z-50">
                            <Button onClick={() => window.print()}><Printer size={18}/> Print Again</Button>
                            <Button variant="secondary" onClick={onClose}><X size={18}/> Close Preview</Button>
                        </div>

                        <div className="flex items-center gap-4 mb-8 border-b-2 pb-4" style={{borderColor: themeColor}}>
                            {logo && <img src={logo} className="h-16 object-contain" />}
                            <div>
                                <h1 className="text-3xl font-bold uppercase tracking-tight">SHIFT Financial Report</h1>
                                <p className="text-sm text-gray-500">Generated on {date}</p>
                            </div>
                        </div>

                        {type === 'single' && (
                            <div className="max-w-2xl mx-auto border p-8 rounded-lg">
                                <div className="flex justify-between mb-6">
                                    <div>
                                        <h2 className="text-xl font-bold">Transaction Receipt</h2>
                                        <p className="text-gray-500">ID: #{data.id.slice(-6)}</p>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-bold text-lg">{data.date}</div>
                                        <div className="text-gray-500">{data.week}</div>
                                    </div>
                                </div>

                                {data.type === 'general' ? (
                                    <div className="bg-red-50 p-4 rounded border border-red-100 mb-6">
                                        <h3 className="font-bold text-red-700 mb-2">General Fund Deduction</h3>
                                        <p>{data.deductionNotes}</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-3 gap-4 mb-6">
                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-gray-600 mb-2 border-b pb-1">Offering</h3>
                                            <div className="flex justify-between"><span>LAK</span> <span>{formatCurrency(safeNum(data.offering?.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between"><span>USD</span> <span>{formatCurrency(safeNum(data.offering?.usd), 'USD')}</span></div>
                                            <div className="flex justify-between"><span>THB</span> <span>{formatCurrency(safeNum(data.offering?.thb), 'THB')}</span></div>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-gray-600 mb-2 border-b pb-1">Tithes</h3>
                                            <div className="flex justify-between"><span>LAK</span> <span>{formatCurrency(safeNum(data.tithes?.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between"><span>USD</span> <span>{formatCurrency(safeNum(data.tithes?.usd), 'USD')}</span></div>
                                            <div className="flex justify-between"><span>THB</span> <span>{formatCurrency(safeNum(data.tithes?.thb), 'THB')}</span></div>
                                        </div>
                                        <div className="p-4 bg-blue-50 rounded border border-blue-100">
                                            <h3 className="font-bold text-blue-700 mb-2 border-b border-blue-200 pb-1">Gross Total</h3>
                                            <div className="flex justify-between font-bold"><span>LAK</span> <span>{formatCurrency(safeNum(data.offering?.lak)+safeNum(data.tithes?.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between font-bold"><span>USD</span> <span>{formatCurrency(safeNum(data.offering?.usd)+safeNum(data.tithes?.usd), 'USD')}</span></div>
                                            <div className="flex justify-between font-bold"><span>THB</span> <span>{formatCurrency(safeNum(data.offering?.thb)+safeNum(data.tithes?.thb), 'THB')}</span></div>
                                        </div>
                                    </div>
                                )}

                                <div className="mb-6">
                                    <h3 className="font-bold border-b mb-2 pb-1">Deductions / Expenses</h3>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="w-1/2 text-gray-600 italic">{data.deductionNotes || 'No notes provided'}</div>
                                        <div className="w-1/2 text-right">
                                            <div className="text-red-600">₭ {formatCurrency(safeNum(data.deductions?.lak), 'LAK')}</div>
                                            <div className="text-red-600">$ {formatCurrency(safeNum(data.deductions?.usd), 'USD')}</div>
                                            <div className="text-red-600">฿ {formatCurrency(safeNum(data.deductions?.thb), 'THB')}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="border-t-2 pt-4 mt-8">
                                    <div className="flex justify-between items-end">
                                        <div className="text-sm text-gray-500">
                                            Authorized Signature: _______________________
                                        </div>
                                        <div className="text-right">
                                            <h3 className="font-bold text-xl">Net Balance</h3>
                                            <div className="font-mono font-bold">
                                                <div>₭ {formatCurrency((safeNum(data.offering?.lak)+safeNum(data.tithes?.lak))-safeNum(data.deductions?.lak), 'LAK')}</div>
                                                <div>$ {formatCurrency((safeNum(data.offering?.usd)+safeNum(data.tithes?.usd))-safeNum(data.deductions?.usd), 'USD')}</div>
                                                <div>฿ {formatCurrency((safeNum(data.offering?.thb)+safeNum(data.tithes?.thb))-safeNum(data.deductions?.thb), 'THB')}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {type === 'list' && (
                            <div>
                                <h2 className="text-xl font-bold mb-4">Transaction Report</h2>
                                <table className="w-full text-sm border-collapse border border-gray-300">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border p-2 text-left">Date</th>
                                            <th className="border p-2 text-left">Description</th>
                                            <th className="border p-2 text-right">Gross (Off+Tith)</th>
                                            <th className="border p-2 text-right">Deductions</th>
                                            <th className="border p-2 text-right">Net Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.map((e, i) => {
                                            const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                                            const grossLak = safeNum(off.lak) + safeNum(tit.lak);
                                            const grossUsd = safeNum(off.usd) + safeNum(tit.usd);
                                            const grossThb = safeNum(off.thb) + safeNum(tit.thb);
                                            
                                            const netLak = grossLak - safeNum(ded.lak);
                                            const netUsd = grossUsd - safeNum(ded.usd);
                                            const netThb = grossThb - safeNum(ded.thb);

                                            return (
                                                <tr key={i} className="border-b">
                                                    <td className="border p-2">{e.date}</td>
                                                    <td className="border p-2">
                                                        <div className="font-bold">{e.week}</div>
                                                        {e.deductionNotes && <div className="text-xs italic text-gray-500">{e.deductionNotes}</div>}
                                                    </td>
                                                    <td className="border p-2 text-right text-xs">
                                                        <div>₭ {formatCurrency(grossLak, 'LAK')}</div>
                                                        <div>$ {formatCurrency(grossUsd, 'USD')}</div>
                                                        <div>฿ {formatCurrency(grossThb, 'THB')}</div>
                                                    </td>
                                                    <td className="border p-2 text-right text-xs text-red-600">
                                                        <div>{safeNum(ded.lak) > 0 ? `-₭ ${formatCurrency(ded.lak,'LAK')}` : '-'}</div>
                                                        <div>{safeNum(ded.usd) > 0 ? `-$ ${formatCurrency(ded.usd,'USD')}` : '-'}</div>
                                                        <div>{safeNum(ded.thb) > 0 ? `-฿ ${formatCurrency(ded.thb,'THB')}` : '-'}</div>
                                                    </td>
                                                    <td className="border p-2 text-right text-xs font-bold">
                                                        <div>₭ {formatCurrency(netLak, 'LAK')}</div>
                                                        <div>$ {formatCurrency(netUsd, 'USD')}</div>
                                                        <div>฿ {formatCurrency(netThb, 'THB')}</div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                );
                
                return createPortal(content, document.getElementById('print-root'));
            };

            // --- View Modal ---
            const ViewEntryModal = ({ entry, onClose, onEdit, onPrint, themeColor }) => {
                if (!entry) return null;
                
                const off = entry.offering || {}; const tit = entry.tithes || {}; const ded = entry.deductions || {};
                const grossLak = safeNum(off.lak) + safeNum(tit.lak);
                const grossUsd = safeNum(off.usd) + safeNum(tit.usd);
                const grossThb = safeNum(off.thb) + safeNum(tit.thb);
                
                const netLak = grossLak - safeNum(ded.lak);
                const netUsd = grossUsd - safeNum(ded.usd);
                const netThb = grossThb - safeNum(ded.thb);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
                            <div className="p-6 border-b flex justify-between items-center bg-slate-50 sticky top-0">
                                <div>
                                    <h2 className="text-xl font-bold text-slate-800">Transaction Details</h2>
                                    <p className="text-slate-500 text-sm">{entry.date} • {entry.week}</p>
                                </div>
                                <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
                            </div>
                            
                            <div className="p-6 space-y-6">
                                {entry.type !== 'general' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="p-4 bg-slate-50 rounded-lg border">
                                            <h4 className="font-bold text-slate-600 mb-2 border-b pb-1">Offerings</h4>
                                            <div className="flex justify-between text-sm"><span>LAK</span> <span>{formatCurrency(safeNum(off.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between text-sm"><span>USD</span> <span>{formatCurrency(safeNum(off.usd), 'USD')}</span></div>
                                            <div className="flex justify-between text-sm"><span>THB</span> <span>{formatCurrency(safeNum(off.thb), 'THB')}</span></div>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-lg border">
                                            <h4 className="font-bold text-slate-600 mb-2 border-b pb-1">Tithes</h4>
                                            <div className="flex justify-between text-sm"><span>LAK</span> <span>{formatCurrency(safeNum(tit.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between text-sm"><span>USD</span> <span>{formatCurrency(safeNum(tit.usd), 'USD')}</span></div>
                                            <div className="flex justify-between text-sm"><span>THB</span> <span>{formatCurrency(safeNum(tit.thb), 'THB')}</span></div>
                                        </div>
                                        <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                            <h4 className="font-bold text-blue-700 mb-2 border-b border-blue-200 pb-1">Gross Total</h4>
                                            <div className="flex justify-between text-sm font-bold"><span>LAK</span> <span>{formatCurrency(grossLak, 'LAK')}</span></div>
                                            <div className="flex justify-between text-sm font-bold"><span>USD</span> <span>{formatCurrency(grossUsd, 'USD')}</span></div>
                                            <div className="flex justify-between text-sm font-bold"><span>THB</span> <span>{formatCurrency(grossThb, 'THB')}</span></div>
                                        </div>
                                    </div>
                                )}

                                <div className="p-4 bg-red-50 rounded-lg border border-red-100">
                                    <h4 className="font-bold text-red-700 mb-2 border-b border-red-200 pb-1">Deductions</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <div className="flex justify-between text-sm"><span>LAK</span> <span>{formatCurrency(safeNum(ded.lak), 'LAK')}</span></div>
                                            <div className="flex justify-between text-sm"><span>USD</span> <span>{formatCurrency(safeNum(ded.usd), 'USD')}</span></div>
                                            <div className="flex justify-between text-sm"><span>THB</span> <span>{formatCurrency(safeNum(ded.thb), 'THB')}</span></div>
                                        </div>
                                        <div className="text-sm italic text-slate-600 bg-white p-2 rounded border">
                                            <span className="font-bold not-italic">Notes: </span> {entry.deductionNotes || 'None'}
                                        </div>
                                    </div>
                                </div>

                                <div className="p-4 bg-slate-900 text-white rounded-lg shadow-lg">
                                    <h4 className="font-bold text-slate-300 mb-4 border-b border-slate-700 pb-2 uppercase tracking-wider text-sm">Net Balance</h4>
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <div className="text-xs text-slate-400 mb-1">LAK</div>
                                            <div className="text-xl font-mono font-bold text-blue-400">₭ {formatCurrency(netLak, 'LAK')}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-slate-400 mb-1">USD</div>
                                            <div className="text-xl font-mono font-bold text-green-400">$ {formatCurrency(netUsd, 'USD')}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-slate-400 mb-1">THB</div>
                                            <div className="text-xl font-mono font-bold text-amber-400">฿ {formatCurrency(netThb, 'THB')}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4 border-t bg-slate-50 flex justify-end gap-2 sticky bottom-0 rounded-b-xl">
                                <Button variant="outline" onClick={onPrint}><Printer size={18} /> Print</Button>
                                <Button variant="secondary" onClick={() => onEdit(entry)}><Pencil size={18} /> Edit</Button>
                                <Button onClick={onClose} style={{backgroundColor: themeColor}}>Close</Button>
                            </div>
                        </div>
                    </div>
                );
            };

            const NavItem = ({ active, onClick, icon, label, themeColor }) => (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all whitespace-nowrap mb-1 ${active ? 'text-white shadow-lg font-semibold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`} style={active ? { backgroundColor: themeColor } : {}}>{icon} <span className="">{label}</span></button>
            );

            const CalcInput = ({ label, value, onChange, onCalc }) => (
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">{label}</label>
                    <div className="relative flex items-center">
                        <input type="text" placeholder="0" className="w-full p-2 pl-3 pr-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-right font-medium text-slate-700" value={formatNumberString(value)} onChange={onChange} />
                        <button type="button" onClick={onCalc} className="absolute right-2 text-slate-400 hover:text-blue-600 p-1"><CalculatorIcon size={16} /></button>
                    </div>
                </div>
            );

            const CurrencyCounterModal = ({ isOpen, onClose, onApply, themeColor, history = [], onSave }) => {
                if (!isOpen) return null;
                const [activeTab, setActiveTab] = useState('count');
                const [counts, setCounts] = useState({ 100000: '', 50000: '', 20000: '', 10000: '', 5000: '', 2000: '', 1000: '', 500: '' });
                const denominations = [100000, 50000, 20000, 10000, 5000, 2000, 1000, 500];
                
                const total = denominations.reduce((sum, d) => sum + (d * (parseInt(counts[d]) || 0)), 0);
                
                const handleChange = (denom, val) => {
                    const cleanVal = val.replace(/,/g, '');
                    if(!isNaN(cleanVal)) {
                        setCounts(prev => ({...prev, [denom]: cleanVal}));
                    }
                };

                const handleApply = () => {
                    if (total > 0 && onSave) {
                        onSave({
                            id: Date.now(),
                            date: new Date().toISOString(),
                            total,
                            counts: { ...counts }
                        });
                    }
                    onApply(total.toString());
                };

                const handleRestore = (savedCounts) => {
                    setCounts(savedCounts);
                    setActiveTab('count');
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                            <div className="p-4 border-b bg-white z-10">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Banknote size={20} /> Bill Counter (LAK)</h3>
                                    <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
                                </div>
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setActiveTab('count')} className={`flex-1 py-1 text-sm font-medium rounded-md transition-all ${activeTab === 'count' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>Calculator</button>
                                    <button onClick={() => setActiveTab('history')} className={`flex-1 py-1 text-sm font-medium rounded-md transition-all ${activeTab === 'history' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>History</button>
                                </div>
                            </div>
                            
                            <div className="overflow-y-auto flex-1 p-4">
                                {activeTab === 'count' ? (
                                    <div className="space-y-3">
                                        {denominations.map(d => (
                                            <div key={d} className="flex items-center gap-3">
                                                <div className="w-24 font-bold text-slate-600 text-right">{formatNumberString(d.toString())}</div>
                                                <span className="text-slate-400">x</span>
                                                <input type="text" className="flex-1 p-2 border rounded-lg outline-none text-center focus:ring-2" style={{'--tw-ring-color': themeColor}} placeholder="0" value={counts[d]} onChange={e => handleChange(d, e.target.value)} />
                                                <div className="w-32 text-right font-mono font-medium">{formatNumberString((d * (parseInt(counts[d]) || 0)).toString())}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {history.length === 0 ? (
                                            <div className="text-center text-slate-400 py-8 italic">No history available</div>
                                        ) : (
                                            history.map(item => (
                                                <div key={item.id} className="border rounded-lg p-3 hover:bg-slate-50 transition-colors">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <div className="font-bold text-slate-700">₭ {formatNumberString(item.total)}</div>
                                                            <div className="text-xs text-slate-400 flex items-center gap-1"><Clock size={10} /> {new Date(item.date).toLocaleString()}</div>
                                                        </div>
                                                        <Button variant="secondary" className="px-2 py-1 text-xs h-auto" onClick={() => handleRestore(item.counts)}>Restore</Button>
                                                    </div>
                                                    <div className="text-xs text-slate-500 flex flex-wrap gap-x-3 gap-y-1 bg-slate-100 p-2 rounded">
                                                        {denominations.map(d => item.counts[d] ? (
                                                            <span key={d}>{formatNumberString(d.toString())} x <b>{item.counts[d]}</b></span>
                                                        ) : null)}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>

                            {activeTab === 'count' && (
                                <div className="p-4 border-t bg-slate-50">
                                    <div className="flex justify-between items-center mb-4"><span className="font-bold text-slate-600">Total</span><span className="text-2xl font-bold text-blue-600">{formatNumberString(total.toString())}</span></div>
                                    <div className="grid grid-cols-2 gap-3"><Button variant="outline" onClick={onClose}>Close</Button><Button onClick={handleApply} style={{backgroundColor: themeColor}}>Apply & Save</Button></div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const StandardCalculatorModal = ({ isOpen, onClose, onApply, themeColor }) => {
                const [input, setInput] = useState('');
                useEffect(() => {
                    if (!isOpen) return;
                    const handleKeyDown = (e) => {
                        const key = e.key;
                        if (/[0-9\.\+\-\*\/\(\)]/.test(key)) setInput(prev => prev + key);
                        else if (key === 'Enter') { e.preventDefault(); calculate(); }
                        else if (key === 'Backspace') setInput(prev => prev.slice(0, -1));
                        else if (key === 'Escape') onClose();
                    };
                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }, [isOpen, input]);
                if (!isOpen) return null;
                const handleClick = (val) => {
                    if (val === 'C') setInput('');
                    else if (val === 'Del') setInput(input.slice(0, -1));
                    else if (val === '=') calculate();
                    else setInput(input + val);
                };
                const calculate = () => { try { const result = String(eval(input)); setInput(result); } catch { setInput('Error'); } };
                const displayValue = input.replace(/(\d+)/g, (match) => parseInt(match).toLocaleString());
                const btns = ['C', '(', ')', '/', '7', '8', '9', '*', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', 'Del', '='];
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-72 overflow-hidden">
                            <div className="p-4 bg-slate-100 border-b flex justify-between items-center">
                                <h3 className="font-bold text-slate-700">Calculator</h3>
                                <button onClick={onClose}><X size={20} className="text-slate-400" /></button>
                            </div>
                            <div className="p-4 bg-slate-50 text-right text-3xl font-mono font-medium h-20 flex items-center justify-end overflow-x-auto tracking-wider border-b">
                                {displayValue || '0'}
                            </div>
                            <div className="grid grid-cols-4 gap-1 p-2 bg-white">
                                {btns.map(b => (
                                    <button key={b} onClick={() => handleClick(b)} className={`p-4 rounded text-lg font-bold transition-colors ${b === '=' ? 'bg-blue-600 text-white col-span-2' : b === 'C' || b === 'Del' ? 'bg-red-50 text-red-500' : 'bg-slate-50 hover:bg-slate-100 text-slate-700'}`} style={b === '=' ? {backgroundColor: themeColor} : {}}>
                                        {b}
                                    </button>
                                ))}
                            </div>
                            <div className="p-3 border-t bg-slate-50">
                                <Button onClick={() => onApply(input)} className="w-full" style={{backgroundColor: themeColor}}>Apply Result</Button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Entry Form ---
            const EntryForm = ({ onSave, onCancel, themeColor, editingEntry, allEntries, billHistory, onSaveBillCount }) => {
                const [entryType, setEntryType] = useState('weekly');
                const [calcTarget, setCalcTarget] = useState(null); 
                const [showBillCounter, setShowBillCounter] = useState(false);
                const [showStdCalc, setShowStdCalc] = useState(false);

                // Helper to calculate default week description
                const getDefaultWeekDescription = () => {
                    const date = new Date();
                    const day = date.getDate();
                    const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                    const weekNum = Math.ceil((day + firstDayOfMonth) / 7);
                    const month = date.toLocaleString('default', { month: 'long' });
                    const year = date.getFullYear();
                    return `Week ${weekNum} ${month} ${year}`;
                };

                const [formData, setFormData] = useState({
                    date: new Date().toISOString().split('T')[0],
                    week: getDefaultWeekDescription(),
                    deductionNotes: '',
                    offering: { lak: '', usd: '', thb: '' },
                    tithes: { lak: '', usd: '', thb: '' },
                    deductions: { lak: '', usd: '', thb: '' }
                });

                useEffect(() => {
                    if (editingEntry) {
                        setEntryType(editingEntry.type || 'weekly');
                        setFormData({
                            date: editingEntry.date,
                            week: editingEntry.week === 'General Fund Withdrawal' ? '' : editingEntry.week,
                            deductionNotes: editingEntry.deductionNotes || '',
                            offering: { lak: editingEntry.offering?.lak||'', usd: editingEntry.offering?.usd||'', thb: editingEntry.offering?.thb||'' },
                            tithes: { lak: editingEntry.tithes?.lak||'', usd: editingEntry.tithes?.usd||'', thb: editingEntry.tithes?.thb||'' },
                            deductions: { lak: editingEntry.deductions?.lak||'', usd: editingEntry.deductions?.usd||'', thb: editingEntry.deductions?.thb||'' }
                        });
                    }
                }, [editingEntry]);

                const liveStats = useMemo(() => {
                    const off = formData.offering; const tit = formData.tithes; const ded = formData.deductions;
                    const gross = { lak: safeNum(off.lak)+safeNum(tit.lak), usd: safeNum(off.usd)+safeNum(tit.usd), thb: safeNum(off.thb)+safeNum(tit.thb) };
                    const net = { lak: gross.lak-safeNum(ded.lak), usd: gross.usd-safeNum(ded.usd), thb: gross.thb-safeNum(ded.thb) };
                    return { gross, net };
                }, [formData]);

                const availableFunds = useMemo(() => {
                    let t = { lak: 0, usd: 0, thb: 0 };
                    const entriesToCount = editingEntry ? allEntries.filter(e => e.id !== editingEntry.id) : allEntries;
                    entriesToCount.forEach(e => {
                        const off = e.offering||{}; const tit = e.tithes||{}; const ded = e.deductions||{};
                        t.lak += (safeNum(off.lak)+safeNum(tit.lak))-safeNum(ded.lak);
                        t.usd += (safeNum(off.usd)+safeNum(tit.usd))-safeNum(ded.usd);
                        t.thb += (safeNum(off.thb)+safeNum(tit.thb))-safeNum(ded.thb);
                    });
                    return t;
                }, [allEntries, editingEntry]);

                const handleChange = (category, currency, value) => {
                    const cleanValue = value.replace(/,/g, '');
                    if (isNaN(cleanValue) && cleanValue !== '') return;
                    setFormData(prev => ({ ...prev, [category]: { ...prev[category], [currency]: cleanValue } }));
                };

                const openStdCalc = (cat, curr) => { setCalcTarget({cat, curr}); setShowStdCalc(true); };
                const applyStdCalc = (val) => { if (calcTarget && !isNaN(val)) handleChange(calcTarget.cat, calcTarget.curr, val); setShowStdCalc(false); };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const isGeneral = entryType === 'general';
                    const entry = {
                        id: editingEntry ? editingEntry.id : Date.now().toString(),
                        type: entryType,
                        date: formData.date,
                        week: isGeneral ? 'General Fund Withdrawal' : (formData.week || `Week of ${formData.date}`),
                        month: formData.date.slice(0, 7),
                        deductionNotes: formData.deductionNotes,
                        offering: isGeneral ? { lak: 0, usd: 0, thb: 0 } : { lak: safeNum(formData.offering.lak), usd: safeNum(formData.offering.usd), thb: safeNum(formData.offering.thb) },
                        tithes: isGeneral ? { lak: 0, usd: 0, thb: 0 } : { lak: safeNum(formData.tithes.lak), usd: safeNum(formData.tithes.usd), thb: safeNum(formData.tithes.thb) },
                        deductions: { lak: safeNum(formData.deductions.lak), usd: safeNum(formData.deductions.usd), thb: safeNum(formData.deductions.thb) }
                    };
                    onSave(entry);
                };

                return (
                    <div className="max-w-4xl mx-auto">
                        <CurrencyCounterModal 
                            isOpen={showBillCounter} 
                            onClose={() => setShowBillCounter(false)} 
                            onApply={(val) => {handleChange('offering', 'lak', val); setShowBillCounter(false);}} 
                            themeColor={themeColor} 
                            history={billHistory}
                            onSave={onSaveBillCount}
                        />
                        <StandardCalculatorModal isOpen={showStdCalc} onClose={() => setShowStdCalc(false)} onApply={applyStdCalc} themeColor={themeColor} />
                        <header className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div><h2 className="text-2xl font-bold text-slate-800">{editingEntry ? 'Edit Record' : entryType === 'weekly' ? 'Add Weekly Record' : 'General Fund Deduction'}</h2><p className="text-slate-500">{editingEntry ? 'Modify existing transaction details' : 'Enter new transaction details'}</p></div>
                            <Button variant="outline" onClick={onCancel}>Cancel</Button>
                        </header>
                        {!editingEntry && (
                            <div className="flex gap-2 mb-6 bg-slate-100 p-1 rounded-lg w-fit">
                                <button onClick={() => setEntryType('weekly')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${entryType === 'weekly' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>Weekly Collection</button>
                                <button onClick={() => setEntryType('general')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${entryType === 'general' ? 'bg-white shadow text-red-600' : 'text-slate-500 hover:text-slate-700'}`}>General Fund Deduction</button>
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <Card className="p-6">
                                <h3 className="text-lg font-semibold mb-4 border-b pb-2 text-slate-700">Date & Info</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Date</label><input type="date" required className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 outline-none" style={{'--tw-ring-color': themeColor}} value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} /></div>
                                    {entryType === 'weekly' && (<div><label className="block text-sm font-medium text-slate-700 mb-1">Week Description</label><input type="text" placeholder="e.g. Week 4 November" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 outline-none" style={{'--tw-ring-color': themeColor}} value={formData.week} onChange={e => setFormData({...formData, week: e.target.value})} /></div>)}
                                </div>
                            </Card>
                            {entryType === 'weekly' && (
                                <>
                                    <Card className="p-6 relative">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-semibold flex items-center gap-2"><DollarSign className="text-blue-500" size={20}/> Offerings</h3>
                                            <button type="button" onClick={() => setShowBillCounter(true)} className="text-xs flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-1 rounded hover:bg-blue-100"><Banknote size={14} /> Bill Counter (LAK)</button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <CalcInput label="LAK (Kip)" value={formData.offering.lak} onChange={e => handleChange('offering', 'lak', e.target.value)} onCalc={() => openStdCalc('offering', 'lak')} />
                                            <CalcInput label="USD ($)" value={formData.offering.usd} onChange={e => handleChange('offering', 'usd', e.target.value)} onCalc={() => openStdCalc('offering', 'usd')} />
                                            <CalcInput label="THB (Baht)" value={formData.offering.thb} onChange={e => handleChange('offering', 'thb', e.target.value)} onCalc={() => openStdCalc('offering', 'thb')} />
                                        </div>
                                    </Card>
                                    <Card className="p-6">
                                        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><TrendingUp className="text-green-500" size={20}/> Tithes</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <CalcInput label="LAK (Kip)" value={formData.tithes.lak} onChange={e => handleChange('tithes', 'lak', e.target.value)} onCalc={() => openStdCalc('tithes', 'lak')} />
                                            <CalcInput label="USD ($)" value={formData.tithes.usd} onChange={e => handleChange('tithes', 'usd', e.target.value)} onCalc={() => openStdCalc('tithes', 'usd')} />
                                            <CalcInput label="THB (Baht)" value={formData.tithes.thb} onChange={e => handleChange('tithes', 'thb', e.target.value)} onCalc={() => openStdCalc('tithes', 'thb')} />
                                        </div>
                                    </Card>
                                </>
                            )}
                            <Card className={`p-6 border-red-200 ${entryType === 'general' ? 'bg-red-50 ring-2 ring-red-100' : 'bg-red-50/30'}`}>
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-800"><TrendingDown className="text-red-500" size={20}/> {entryType === 'general' ? 'Withdrawal / Expense' : 'Deductions'}</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <CalcInput label="LAK (Kip)" value={formData.deductions.lak} onChange={e => handleChange('deductions', 'lak', e.target.value)} onCalc={() => openStdCalc('deductions', 'lak')} />
                                    <CalcInput label="USD ($)" value={formData.deductions.usd} onChange={e => handleChange('deductions', 'usd', e.target.value)} onCalc={() => openStdCalc('deductions', 'usd')} />
                                    <CalcInput label="THB (Baht)" value={formData.deductions.thb} onChange={e => handleChange('deductions', 'thb', e.target.value)} onCalc={() => openStdCalc('deductions', 'thb')} />
                                </div>
                                <div className="mt-4">
                                    <label className="block text-sm font-bold text-slate-600 mb-1">Notes</label>
                                    <textarea className="w-full p-3 border border-red-200 rounded-lg focus:ring-2 focus:ring-red-200 outline-none text-sm" rows="3" placeholder="e.g. Building Fund..." value={formData.deductionNotes} onChange={e => setFormData({...formData, deductionNotes: e.target.value})}></textarea>
                                </div>
                            </Card>
                            <Card className="p-6 bg-slate-900 text-white">
                                <h3 className="text-lg font-bold mb-4 border-b border-slate-700 pb-2">Transaction Summary</h3>
                                <div className="grid grid-cols-4 gap-4 text-sm">
                                    <div className="col-span-1 flex flex-col justify-end pb-2"><span className="text-slate-400 text-xs font-bold uppercase">Currency</span></div>
                                    <div className="col-span-1 text-right"><span className="text-slate-300 text-xs font-bold uppercase block mb-1">Gross Total</span><span className="text-[10px] text-slate-500 block">(Off + Tithes)</span></div>
                                    <div className="col-span-1 text-right"><span className="text-slate-300 text-xs font-bold uppercase block mb-1">Deductions</span></div>
                                    <div className="col-span-1 text-right"><span className="text-slate-300 text-xs font-bold uppercase block mb-1">Net Total</span><span className="text-[10px] text-slate-500 block">(Final)</span></div>
                                    <div className="font-bold text-blue-400 flex items-center border-t border-slate-800 pt-2">LAK</div><div className="text-right font-mono border-t border-slate-800 pt-2 font-bold text-white">₭ {formatCurrency(liveStats.gross.lak, 'LAK')}</div><div className="text-right font-mono text-red-400 border-t border-slate-800 pt-2">-₭ {formatCurrency(safeNum(formData.deductions.lak), 'LAK')}</div><div className="text-right font-mono font-bold text-blue-400 border-t border-slate-800 pt-2">₭ {formatCurrency(liveStats.net.lak, 'LAK')}</div>
                                    <div className="font-bold text-green-400 flex items-center border-t border-slate-800 pt-2">USD</div><div className="text-right font-mono border-t border-slate-800 pt-2 font-bold text-white">$ {formatCurrency(liveStats.gross.usd, 'USD')}</div><div className="text-right font-mono text-red-400 border-t border-slate-800 pt-2">-$ {formatCurrency(safeNum(formData.deductions.usd), 'USD')}</div><div className="text-right font-mono font-bold text-green-400 border-t border-slate-800 pt-2">$ {formatCurrency(liveStats.net.usd, 'USD')}</div>
                                    <div className="font-bold text-amber-400 flex items-center border-t border-slate-800 pt-2">THB</div><div className="text-right font-mono border-t border-slate-800 pt-2 font-bold text-white">฿ {formatCurrency(liveStats.gross.thb, 'THB')}</div><div className="text-right font-mono text-red-400 border-t border-slate-800 pt-2">-฿ {formatCurrency(safeNum(formData.deductions.thb), 'THB')}</div><div className="text-right font-mono font-bold text-amber-400 border-t border-slate-800 pt-2">฿ {formatCurrency(liveStats.net.thb, 'THB')}</div>
                                </div>
                            </Card>
                            <div className="flex justify-end pt-4">
                                <Button type="submit" className="w-full md:w-auto text-lg px-8" style={{ backgroundColor: themeColor }}><Save size={20} /> {editingEntry ? 'Update Record' : 'Save Record'}
                                </Button>
                            </div>
                        </form>
                    </div>
                );
            };

            // --- Dashboard ---
            const Dashboard = ({ entries, themeColor }) => {
                const [viewMode, setViewMode] = useState('weekly');
                const stats = useMemo(() => {
                    let t = {
                        lak: { off: 0, tit: 0, ded: 0 },
                        usd: { off: 0, tit: 0, ded: 0 },
                        thb: { off: 0, tit: 0, ded: 0 }
                    };
                    entries.forEach(e => {
                        const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                        t.lak.off += safeNum(off.lak); t.lak.tit += safeNum(tit.lak); t.lak.ded += safeNum(ded.lak);
                        t.usd.off += safeNum(off.usd); t.usd.tit += safeNum(tit.usd); t.usd.ded += safeNum(ded.usd);
                        t.thb.off += safeNum(off.thb); t.thb.tit += safeNum(tit.thb); t.thb.ded += safeNum(ded.thb);
                    });
                    return t;
                }, [entries]);

                const chartData = useMemo(() => {
                    const sorted = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
                    if (viewMode === 'weekly') {
                        return sorted.slice(-8).map(e => {
                            const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                            return {
                                name: e.date.slice(5),
                                LAK: (safeNum(off.lak)+safeNum(tit.lak))-safeNum(ded.lak),
                                USD: (safeNum(off.usd)+safeNum(tit.usd))-safeNum(ded.usd),
                                THB: (safeNum(off.thb)+safeNum(tit.thb))-safeNum(ded.thb)
                            };
                        });
                    } else {
                        const m = {};
                        sorted.forEach(e => {
                            const k = e.date.slice(0, 7);
                            if(!m[k]) m[k]={lak:0,usd:0,thb:0};
                            const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                            m[k].lak += ((safeNum(off.lak)+safeNum(tit.lak))-safeNum(ded.lak));
                            m[k].usd += ((safeNum(off.usd)+safeNum(tit.usd))-safeNum(ded.usd));
                            m[k].thb += ((safeNum(off.thb)+safeNum(tit.thb))-safeNum(ded.thb));
                        });
                        return Object.entries(m).map(([k,v]) => ({name:k, LAK:v.lak, USD:v.usd, THB:v.thb})).sort((a,b)=>a.name.localeCompare(b.name)).slice(-12);
                    }
                }, [entries, viewMode]);

                return (
                    <div className="space-y-6">
                        <header className="mb-8 flex justify-between items-end">
                            <div><h2 className="text-2xl font-bold text-slate-800">Financial Dashboard</h2><p className="text-slate-500">Overview of collections and deductions</p></div>
                            <div className="bg-white border border-slate-200 rounded-lg p-1 flex">
                                <button onClick={() => setViewMode('weekly')} className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${viewMode === 'weekly' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>Weekly</button>
                                <button onClick={() => setViewMode('monthly')} className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${viewMode === 'monthly' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>Monthly</button>
                            </div>
                        </header>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <CurrencySummaryCard currency="LAK" offering={stats.lak.off} tithes={stats.lak.tit} expense={stats.lak.ded} color="text-blue-600" />
                            <CurrencySummaryCard currency="USD" offering={stats.usd.off} tithes={stats.usd.tit} expense={stats.usd.ded} color="text-green-600" />
                            <CurrencySummaryCard currency="THB" offering={stats.thb.off} tithes={stats.thb.tit} expense={stats.thb.ded} color="text-amber-600" />
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                            <Card className="p-6"><h3 className="text-lg font-semibold mb-4">Net Fund Trends (LAK)</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><LineChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><XAxis dataKey="name" stroke="#94a3b8" fontSize={12} /><YAxis stroke="#94a3b8" fontSize={12} tickFormatter={(v) => `${(v/1000000).toFixed(1)}M`} /><RechartsTooltip formatter={(v) => new Intl.NumberFormat('en-US').format(v)} contentStyle={{borderRadius: '8px'}} /><Line type="monotone" dataKey="LAK" stroke={themeColor} strokeWidth={3} dot={{r:4}} /></LineChart></ResponsiveContainer></div></Card>
                            <Card className="p-6"><h3 className="text-lg font-semibold mb-4">USD vs THB Trends</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" /><XAxis dataKey="name" stroke="#94a3b8" fontSize={12} /><YAxis stroke="#94a3b8" fontSize={12} /><RechartsTooltip formatter={(v) => new Intl.NumberFormat('en-US').format(v)} contentStyle={{borderRadius: '8px'}} /><Legend /><Bar dataKey="USD" fill="#10b981" radius={[4,4,0,0]} /><Bar dataKey="THB" fill="#f59e0b" radius={[4,4,0,0]} /></BarChart></ResponsiveContainer></div></Card>
                        </div>
                    </div>
                );
            };

            const CurrencySummaryCard = ({ currency, offering, tithes, expense, color }) => {
                const symbol = getSymbol(currency);
                const income = offering + tithes;
                const net = income - expense;
                return (
                    <Card className="p-6 relative overflow-hidden">
                        <div className={`absolute top-0 right-0 p-4 opacity-10 ${color}`}><DollarSign size={64} /></div>
                        <h3 className="text-sm font-medium text-slate-500 uppercase tracking-wider">{currency} Financials</h3>
                        
                        <div className={`mt-2 text-3xl font-bold ${color}`}>
                            {symbol} {formatCurrency(net, currency)} <span className="text-base font-normal text-slate-400">Grand Total</span>
                        </div>

                        <div className="mt-4 space-y-1 border-t pt-3">
                            <div className="flex justify-between text-xs text-slate-500"><span>Offering (+)</span><span>{symbol} {formatCurrency(offering, currency)}</span></div>
                            <div className="flex justify-between text-xs text-slate-500"><span>Tithes (+)</span><span>{symbol} {formatCurrency(tithes, currency)}</span></div>
                            <div className="flex justify-between text-sm font-semibold text-slate-700 border-t border-slate-100 pt-1 mt-1"><span>Gross Total</span><span>{symbol} {formatCurrency(income, currency)}</span></div>
                            <div className="flex justify-between text-xs text-red-500 pt-1"><span>Deductions (-)</span><span>-{symbol} {formatCurrency(expense, currency)}</span></div>
                        </div>
                    </Card>
                );
            };

            const MonthlyReport = ({ entries, themeColor, onPrint }) => {
                const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
                const monthlyData = useMemo(() => {
                    const g = {};
                    entries.forEach(e => {
                        if(e.date.slice(0,4) !== selectedYear) return;
                        const m = e.date.slice(0,7);
                        if(!g[m]) g[m] = { 
                            month: m, 
                            lak: {off:0, tit:0, ded:0, net:0}, 
                            usd: {off:0, tit:0, ded:0, net:0}, 
                            thb: {off:0, tit:0, ded:0, net:0}, 
                            entries: [] 
                        };
                        const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                        g[m].lak.off += safeNum(off.lak); g[m].lak.tit += safeNum(tit.lak); g[m].lak.ded += safeNum(ded.lak);
                        g[m].usd.off += safeNum(off.usd); g[m].usd.tit += safeNum(tit.usd); g[m].usd.ded += safeNum(ded.usd);
                        g[m].thb.off += safeNum(off.thb); g[m].thb.tit += safeNum(tit.thb); g[m].thb.ded += safeNum(ded.thb);
                        g[m].entries.push(e);
                    });
                    Object.values(g).forEach(i => {
                        i.lak.net = (i.lak.off + i.lak.tit) - i.lak.ded;
                        i.usd.net = (i.usd.off + i.usd.tit) - i.usd.ded;
                        i.thb.net = (i.thb.off + i.thb.tit) - i.thb.ded;
                    });
                    return Object.values(g).sort((a,b) => b.month.localeCompare(a.month));
                }, [entries, selectedYear]);

                const years = useMemo(() => Array.from(new Set(entries.map(e => e.date.slice(0,4)))).sort().reverse(), [entries]);
                const activeYears = years.length > 0 ? years : [new Date().getFullYear().toString()];

                return (
                    <div className="space-y-6">
                        <header className="flex justify-between items-center">
                            <div><h2 className="text-2xl font-bold text-slate-800">Monthly Reports</h2></div>
                            <div className="flex gap-2">
                                <Button variant="outline" onClick={() => onPrint(monthlyData)}><Printer size={18} /> Print Report</Button>
                                <div className="flex items-center gap-2 bg-white p-2 rounded-lg border"><Filter size={18} className="text-slate-400" /><select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="bg-transparent outline-none">{activeYears.map(y => <option key={y} value={y}>{y}</option>)}</select></div>
                            </div>
                        </header>
                        <div className="space-y-4">{monthlyData.map(m => <MonthlyCard key={m.month} data={m} />)}</div>
                    </div>
                );
            };

            const MonthlyCard = ({ data }) => {
                const [expanded, setExpanded] = useState(false);
                return (
                    <Card className="overflow-hidden">
                        <div className="p-4 flex justify-between cursor-pointer hover:bg-slate-50" onClick={() => setExpanded(!expanded)}>
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center font-bold">{new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'short' })}</div>
                                <div><h3 className="font-bold text-slate-800">{new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3></div>
                            </div>
                            <button className="text-slate-400">{expanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}</button>
                        </div>
                        {expanded && <div className="px-4 pb-4 bg-slate-50 border-t border-slate-100">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 mb-6">
                                <DetailBox title="LAK" data={data.lak} color="blue" /> <DetailBox title="USD" data={data.usd} color="green" /> <DetailBox title="THB" data={data.thb} color="amber" />
                            </div>
                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase">Transactions</h4>
                            <div className="bg-white rounded border overflow-hidden overflow-x-auto">
                                <table className="w-full text-xs text-left"><thead className="bg-slate-100"><tr><th className="p-2">Date</th><th className="p-2">Desc</th><th className="p-2 text-right">LAK</th><th className="p-2 text-right">USD</th><th className="p-2 text-right">THB</th></tr></thead>
                                <tbody className="divide-y">{data.entries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => {
                                    const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                                    const nl = (safeNum(off.lak)+safeNum(tit.lak))-safeNum(ded.lak); 
                                    const nu = (safeNum(off.usd)+safeNum(tit.usd))-safeNum(ded.usd); 
                                    const nt = (safeNum(off.thb)+safeNum(tit.thb))-safeNum(ded.thb);
                                    return <tr key={e.id}><td className="p-2">{e.date}</td><td className="p-2 text-slate-500">{e.week}</td><td className="p-2 text-right text-blue-600">₭ {formatCurrency(nl,'LAK')}</td><td className="p-2 text-right text-green-600">$ {formatCurrency(nu,'USD')}</td><td className="p-2 text-right text-amber-600">฿ {formatCurrency(nt,'THB')}</td></tr>;
                                })}</tbody></table>
                            </div>
                        </div>}
                    </Card>
                );
            };

            const DetailBox = ({ title, data, color }) => (
                <div className="bg-white p-3 rounded border shadow-sm text-sm">
                    <h4 className={`font-bold text-${color}-600 mb-2`}>{title}</h4>
                    <div className="flex justify-between border-b pb-1"><span className="text-slate-500">Offering</span><span>{formatCurrency(data.off, title)}</span></div>
                    <div className="flex justify-between border-b pb-1"><span className="text-slate-500">Tithes</span><span>{formatCurrency(data.tit, title)}</span></div>
                    <div className="flex justify-between border-b py-1"><span className="text-slate-500">Deductions</span><span className="text-red-500">-{formatCurrency(data.ded, title)}</span></div>
                    <div className="flex justify-between pt-1 font-bold"><span>Net</span><span>{formatCurrency(data.net, title)}</span></div>
                </div>
            );

            const RecordsTable = ({ entries, onDelete, onEdit, onView, onPrintSingle, onPrintList, themeColor }) => {
                const [filterYear, setFilterYear] = useState('All');
                const [filterMonth, setFilterMonth] = useState('All');
                const years = useMemo(() => Array.from(new Set(entries.map(e => e.date.slice(0,4)))).sort().reverse(), [entries]);
                const filtered = useMemo(() => entries.filter(e => (filterYear === 'All' || e.date.slice(0,4) === filterYear) && (filterMonth === 'All' || e.date.slice(5,7) === filterMonth)).sort((a,b) => new Date(b.date) - new Date(a.date)), [entries, filterYear, filterMonth]);

                return (
                    <div className="space-y-4">
                        <header className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-slate-800">All Records</h2>
                            <div className="flex gap-2 items-center">
                                <Button variant="outline" onClick={() => onPrintList(filtered)}><Printer size={18} /> Print List</Button>
                                <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="bg-white border rounded p-2 text-sm"><option value="All">All Years</option>{years.map(y=><option key={y} value={y}>{y}</option>)}</select>
                                <select value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="bg-white border rounded p-2 text-sm"><option value="All">All Months</option>{Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0')).map(m=><option key={m} value={m}>{new Date('2024-'+m+'-01').toLocaleString('default',{month:'short'})}</option>)}</select>
                            </div>
                        </header>
                        <Card className="overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 border-b"><tr><th className="px-6 py-3">Date</th><th className="px-6 py-3">Breakdown (Off + Tith)</th><th className="px-6 py-3">Deductions</th><th className="px-6 py-3">Net</th><th className="px-6 py-3 text-right">Actions</th></tr></thead>
                                    <tbody className="divide-y">{filtered.length===0 ? <tr><td colSpan="5" className="px-6 py-8 text-center text-slate-400">No records.</td></tr> : filtered.map(e => {
                                        const off = e.offering || {}; const tit = e.tithes || {}; const ded = e.deductions || {};
                                        const lG = safeNum(off.lak)+safeNum(tit.lak), uG = safeNum(off.usd)+safeNum(tit.usd), tG = safeNum(off.thb)+safeNum(tit.thb);
                                        const lN = lG-safeNum(ded.lak), uN = uG-safeNum(ded.usd), tN = tG-safeNum(ded.thb);
                                        return (
                                            <tr key={e.id} className={`hover:bg-slate-50 ${e.type==='general'?'bg-amber-50/50':''}`}>
                                                <td className="px-6 py-4 align-top"><div className="font-bold">{e.date}</div><div className="text-xs text-slate-500">{e.week}</div></td>
                                                <td className="px-6 py-4 align-top text-slate-600">
                                                    {e.type==='general' ? <span className="italic text-xs">No Collection</span> : (
                                                        <div className="grid gap-1 text-xs">
                                                            <div className="grid grid-cols-[40px_1fr] gap-2"><span>LAK:</span><span className="font-medium">₭{formatCurrency(safeNum(off.lak),'LAK')} + ₭{formatCurrency(safeNum(tit.lak),'LAK')}</span></div>
                                                            <div className="grid grid-cols-[40px_1fr] gap-2"><span>USD:</span><span className="font-medium">${formatCurrency(safeNum(off.usd),'USD')} + ${formatCurrency(safeNum(tit.usd),'USD')}</span></div>
                                                            <div className="grid grid-cols-[40px_1fr] gap-2"><span>THB:</span><span className="font-medium">฿{formatCurrency(safeNum(off.thb),'THB')} + ฿{formatCurrency(safeNum(tit.thb),'THB')}</span></div>
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 align-top text-red-500 text-xs">
                                                    <div>-₭ {formatCurrency(safeNum(ded.lak),'LAK')}</div>
                                                    <div>-$ {formatCurrency(safeNum(ded.usd),'USD')}</div>
                                                    <div>-฿ {formatCurrency(safeNum(ded.thb),'THB')}</div>
                                                    {e.deductionNotes && <div className="text-slate-500 mt-1 italic bg-white border p-1 rounded">{e.deductionNotes}</div>}
                                                </td>
                                                <td className="px-6 py-4 align-top font-medium text-xs">
                                                    <div>₭ {formatCurrency(lN,'LAK')}</div>
                                                    <div>$ {formatCurrency(uN,'USD')}</div>
                                                    <div>฿ {formatCurrency(tN,'THB')}</div>
                                                </td>
                                                <td className="px-6 py-4 align-top text-right flex justify-end gap-2">
                                                    <button onClick={() => onPrintSingle(e)} className="text-slate-400 hover:text-gray-600"><Printer size={18} /></button>
                                                    <button onClick={() => onView(e)} className="text-slate-400 hover:text-blue-600"><Eye size={18} /></button>
                                                    <button onClick={() => onEdit(e)} className="text-slate-400 hover:text-green-600"><Pencil size={18} /></button>
                                                    <button onClick={() => onDelete(e.id)} className="text-slate-400 hover:text-red-600"><Trash2 size={18} /></button>
                                                </td>
                                            </tr>
                                        );
                                    })}</tbody>
                                </table>
                            </div>
                        </Card>
                    </div>
                );
            };

            const SettingsPage = ({ settings, updateSettings, onClear, onImport, entries, onLogout }) => {
                const fileInputRef = useRef(null);
                const splashInputRef = useRef(null);
                const faviconInputRef = useRef(null);
                const importFileRef = useRef(null);
                const [isFirebase, setIsFirebase] = useState(false);

                useEffect(() => {
                    if (window.db) setIsFirebase(true);
                }, []);
                
                const handleFileChange = (e, type) => {
                    const file = e.target.files[0];
                    if (file && file.size < 500000) {
                        const reader = new FileReader();
                        reader.onloadend = () => updateSettings(type, reader.result);
                        reader.readAsDataURL(file);
                    } else if (file) alert("File too large (max 500KB).");
                };
                
                const handleImportFileChange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            onImport(importedData);
                        } catch (err) {
                            alert("Failed to parse JSON file.");
                        }
                        e.target.value = null; 
                    };
                    reader.readAsText(file);
                };
                
                const exportData = () => {
                    const a = document.createElement('a');
                    a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(entries));
                    a.download = "shift_backup.json";
                    document.body.appendChild(a); a.click(); a.remove();
                };
                return (
                    <div className="space-y-6 max-w-2xl">
                        <header><h2 className="text-2xl font-bold text-slate-800">Settings</h2></header>
                        <Card className="p-6">
                            <h3 className="font-bold mb-4 flex items-center gap-2"><Cloud size={20} className={isFirebase ? "text-green-500" : "text-slate-400"} /> Database Status</h3>
                            <div className="flex items-center gap-3 mb-2">
                                <div className={`w-3 h-3 rounded-full ${isFirebase ? "bg-green-500 animate-pulse" : "bg-slate-300"}`}></div>
                                <span className="font-medium text-slate-700">{isFirebase ? "Connected to Cloud Database (Firebase)" : "Local Storage Mode"}</span>
                            </div>
                            {!isFirebase && <p className="text-xs text-slate-500">Edit the source code to add your Firebase configuration for cloud sync.</p>}
                        </Card>

                        <Card className="p-6">
                            <h3 className="font-bold mb-4 flex items-center gap-2"><Palette size={20} className="text-blue-500" /> Branding</h3>
                            
                            <div className="flex gap-4 items-center mb-6 border-b border-slate-100 pb-6">
                                <div className="h-20 w-20 rounded bg-slate-100 flex items-center justify-center overflow-hidden border">{settings.logo ? <img src={settings.logo} className="h-full w-full object-contain" /> : <ImageIcon className="text-slate-400" />}</div>
                                <div className="flex flex-col gap-2">
                                    <span className="text-sm font-bold text-slate-600">Dashboard Logo</span>
                                    <input type="file" ref={fileInputRef} onChange={(e) => handleFileChange(e, 'logo')} className="hidden" />
                                    <Button variant="secondary" onClick={() => fileInputRef.current.click()}>Upload Logo</Button>
                                    {settings.logo && <button onClick={() => updateSettings('logo', null)} className="text-xs text-red-500">Remove</button>}
                                </div>
                            </div>
                            
                            <div className="flex gap-4 items-center mb-6 border-b border-slate-100 pb-6">
                                <div className="h-20 w-20 rounded bg-slate-900 flex items-center justify-center overflow-hidden border">
                                    {settings.splashLogo ? <img src={settings.splashLogo} className="h-full w-full object-contain" /> : <ImageIcon className="text-slate-600" />}
                                </div>
                                <div className="flex flex-col gap-2">
                                    <span className="text-sm font-bold text-slate-600">Splash Screen Logo</span>
                                    <input type="file" ref={splashInputRef} onChange={(e) => handleFileChange(e, 'splashLogo')} className="hidden" />
                                    <Button variant="secondary" onClick={() => splashInputRef.current.click()}>Upload Splash Logo</Button>
                                    {settings.splashLogo && <button onClick={() => updateSettings('splashLogo', null)} className="text-xs text-red-500">Remove</button>}
                                </div>
                            </div>

                            <div className="flex gap-4 items-center mb-6 border-b border-slate-100 pb-6">
                                <div className="h-20 w-20 rounded bg-slate-50 flex items-center justify-center overflow-hidden border">
                                    {settings.favicon ? <img src={settings.favicon} className="h-10 w-10 object-contain" /> : <Globe className="text-slate-400" />}
                                </div>
                                <div className="flex flex-col gap-2">
                                    <span className="text-sm font-bold text-slate-600">App Icon / Favicon</span>
                                    <p className="text-xs text-slate-500">Used for browser tab and mobile home screen icon.</p>
                                    <input type="file" ref={faviconInputRef} onChange={(e) => handleFileChange(e, 'favicon')} className="hidden" />
                                    <Button variant="secondary" onClick={() => faviconInputRef.current.click()}>Upload Icon</Button>
                                    {settings.favicon && <button onClick={() => updateSettings('favicon', null)} className="text-xs text-red-500">Remove</button>}
                                </div>
                            </div>

                            <div><label className="block text-sm font-medium mb-2">Theme Color</label><div className="flex gap-3">{['#3b82f6','#10b981','#8b5cf6','#f43f5e','#475569'].map(c => <button key={c} onClick={() => updateSettings('themeColor', c)} className={`w-8 h-8 rounded-full border-2 ${settings.themeColor === c ? 'border-slate-800 scale-110' : 'border-transparent'}`} style={{backgroundColor: c}} />)}</div></div>
                        </Card>
                        <Card className="p-6"><h3 className="font-bold mb-4 flex items-center gap-2"><Download size={20} className="text-blue-500" /> Data Management</h3><div className="flex gap-4 flex-wrap">
                            <Button variant="outline" onClick={exportData}>Backup JSON</Button>
                            <input type="file" ref={importFileRef} onChange={handleImportFileChange} accept=".json" className="hidden" />
                            <Button variant="outline" onClick={() => importFileRef.current.click()}><Upload size={18} /> Restore JSON</Button>
                            <Button variant="danger" onClick={onClear}>Clear Local Data</Button></div></Card>
                        
                        <Card className="p-6 border-red-100">
                            <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><LogOut size={20} className="text-red-500" /> Account</h3>
                            <p className="text-sm text-slate-500 mb-4">Sign out of your account to return to the splash screen.</p>
                            <Button variant="danger" onClick={onLogout} className="w-full md:w-auto"><LogOut size={18}/> Sign Out</Button>
                        </Card>
                    </div>
                );
            };

            // --- Main App (The Financial System) ---
            const DashboardApp = ({ onLogout }) => {
                const [activeTab, setActiveTab] = useState('dashboard');
                const [entries, setEntries] = useState([]);
                const [billHistory, setBillHistory] = useState([]);
                const [editingEntry, setEditingEntry] = useState(null);
                const [viewingEntry, setViewingEntry] = useState(null);
                const [printData, setPrintData] = useState(null); 
                const [settings, setSettings] = useState({ themeColor: '#3b82f6', logo: null, splashLogo: null, favicon: null });

                // Load Settings & Data
                useEffect(() => {
                    const savedTab = localStorage.getItem('shift_active_tab'); 
                    if (savedTab) setActiveTab(savedTab);

                    // 1. Initial Load from LocalStorage (Fallback only if no Cloud config)
                    const localData = localStorage.getItem('shift_financial_data');
                    const localHistory = localStorage.getItem('shift_bill_history');
                    const localSettings = localStorage.getItem('shift_app_settings');
                    
                    // Only load local data if we don't have Firebase or while waiting
                    if (!window.db) {
                        if (localData) try { setEntries(JSON.parse(localData)); } catch(e) {}
                        if (localHistory) try { setBillHistory(JSON.parse(localHistory)); } catch(e) {}
                    }
                    
                    if (localSettings) {
                        try { 
                            const s = JSON.parse(localSettings);
                            setSettings(s);
                            applyFavicon(s.favicon); 
                        } catch(e) {}
                    }

                    // 2. Firebase Sync
                    if (window.db && window.fs) {
                        console.log("Syncing with Firebase...");
                        
                        // Transactions
                        const q = window.fs.query(window.fs.collection(window.db, "transactions"), window.fs.orderBy("date", "desc"));
                        const unsubscribeEntries = window.fs.onSnapshot(q, (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            setEntries(data);
                            // NOTE: We do NOT save to localStorage here anymore as requested
                        });

                        // Bill History
                        const qHistory = window.fs.query(window.fs.collection(window.db, "bill_history"), window.fs.orderBy("date", "desc"));
                        const unsubscribeHistory = window.fs.onSnapshot(qHistory, (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            setBillHistory(data);
                        });

                        // Settings (Logos, Theme, Favicon)
                        const settingsDoc = window.fs.doc(window.db, "config", "app_settings");
                        const unsubscribeSettings = window.fs.onSnapshot(settingsDoc, (doc) => {
                            if (doc.exists()) {
                                const newSettings = doc.data();
                                setSettings(newSettings);
                                // We still cache settings locally for the splash screen to work before DB loads
                                localStorage.setItem('shift_app_settings', JSON.stringify(newSettings));
                                if(newSettings.splashLogo) localStorage.setItem('shift_splash_logo', newSettings.splashLogo);
                                if(newSettings.favicon) applyFavicon(newSettings.favicon);
                            }
                        });

                        return () => {
                            unsubscribeEntries();
                            unsubscribeHistory();
                            unsubscribeSettings();
                        };
                    }
                }, []);

                useEffect(() => { localStorage.setItem('shift_active_tab', activeTab); }, [activeTab]);

                const handleUpdateSettings = async (key, value) => {
                    const newSettings = { ...settings, [key]: value };
                    setSettings(newSettings); 
                    
                    if (key === 'favicon') applyFavicon(value);
                    if (key === 'splashLogo') localStorage.setItem('shift_splash_logo', value);

                    localStorage.setItem('shift_app_settings', JSON.stringify(newSettings));

                    if (window.db && window.fs) {
                        try {
                            await window.fs.setDoc(window.fs.doc(window.db, "config", "app_settings"), newSettings, { merge: true });
                        } catch(e) { console.error("Error saving settings to cloud:", e); }
                    }
                };

                const handleSaveEntry = async (entry) => {
                    if (window.db && window.fs) {
                        try {
                            await window.fs.setDoc(window.fs.doc(window.db, "transactions", entry.id), entry);
                        } catch (e) { alert("Error saving to cloud. Check console."); }
                    } else {
                        // Local fallback only if no Cloud
                        const newEntries = editingEntry 
                            ? entries.map(e => e.id === entry.id ? entry : e)
                            : [entry, ...entries];
                        setEntries(newEntries);
                        localStorage.setItem('shift_financial_data', JSON.stringify(newEntries));
                    }
                    setEditingEntry(null);
                    setActiveTab('dashboard');
                };

                const handleSaveBillCount = async (record) => {
                    if (window.db && window.fs) {
                        try {
                            await window.fs.setDoc(window.fs.doc(window.db, "bill_history", record.id.toString()), record);
                        } catch (e) { console.error("Error saving bill history: ", e); }
                    } else {
                        const newHistory = [record, ...billHistory].slice(0, 50);
                        setBillHistory(newHistory);
                        localStorage.setItem('shift_bill_history', JSON.stringify(newHistory));
                    }
                };

                const handleDeleteEntry = async (id) => {
                    if (confirm('Are you sure you want to delete this record?')) {
                        if (window.db && window.fs) {
                            try { await window.fs.deleteDoc(window.fs.doc(window.db, "transactions", id)); } catch (e) { console.error(e); }
                        } else {
                            const newEntries = entries.filter(e => e.id !== id);
                            setEntries(newEntries);
                            localStorage.setItem('shift_financial_data', JSON.stringify(newEntries));
                        }
                    }
                };

                const handleEditEntry = (entry) => {
                    setEditingEntry(entry);
                    setViewingEntry(null);
                    setActiveTab('add');
                };

                const handleClearAll = async () => { 
                    if (confirm('WARNING: Delete ALL data? This cannot be undone.')) {
                        if (window.db && window.fs) {
                            // In cloud mode, we delete docs one by one since client SDK lacks clear()
                            const batchSize = 50;
                            // Naive approach for "easy way": just delete what is in state
                            entries.forEach(async (e) => {
                                try { await window.fs.deleteDoc(window.fs.doc(window.db, "transactions", e.id)); } catch(err){}
                            });
                            billHistory.forEach(async (h) => {
                                try { await window.fs.deleteDoc(window.fs.doc(window.db, "bill_history", h.id)); } catch(err){}
                            });
                            alert("Deletion started. It may take a moment to reflect.");
                        } else {
                            setEntries([]); 
                            setBillHistory([]);
                            localStorage.removeItem('shift_financial_data');
                            localStorage.removeItem('shift_bill_history');
                        }
                    } 
                };
                
                const handleImportData = async (data) => {
                    if (Array.isArray(data)) {
                        if (confirm(`Restoring ${data.length} records. ` + (window.db ? "This will upload them to the Cloud." : "This will REPLACE your local data."))) {
                            if (window.db && window.fs) {
                                let count = 0;
                                for (const item of data) {
                                    try {
                                        await window.fs.setDoc(window.fs.doc(window.db, "transactions", item.id.toString()), item);
                                        count++;
                                    } catch (e) { console.error(e); }
                                }
                                alert(`Uploaded ${count} records to Cloud.`);
                            } else {
                                setEntries(data);
                                localStorage.setItem('shift_financial_data', JSON.stringify(data));
                            }
                        }
                    } else { alert("Invalid backup file format."); }
                };

                const handlePrint = (type, data) => {
                    setPrintData({ type, data });
                };

                return (
                    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col md:flex-row">
                        {printData && (
                            <PrintLayout 
                                data={printData.data} 
                                type={printData.type} 
                                logo={settings.logo} 
                                themeColor={settings.themeColor}
                                onClose={() => setPrintData(null)} 
                            />
                        )}

                        {viewingEntry && (
                            <ViewEntryModal 
                                entry={viewingEntry} 
                                onClose={() => setViewingEntry(null)} 
                                onEdit={handleEditEntry}
                                onPrint={() => handlePrint('single', viewingEntry)}
                                themeColor={settings.themeColor}
                            />
                        )}

                        <aside className="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 md:h-screen sticky top-0 z-50 flex flex-col">
                            <div className="p-6 flex flex-col items-center md:items-start border-b border-slate-800">
                                {settings.logo ? <img src={settings.logo} className="h-16 mb-4 rounded-lg object-contain bg-white/5 p-1" /> : <div className="h-12 w-12 rounded-lg bg-slate-800 flex items-center justify-center mb-4 text-slate-600"><ImageIcon size={24} /></div>}
                                <h1 className="text-xl font-bold flex items-center gap-2"><TrendingUp style={{ color: settings.themeColor }} /> SHIFT Finance</h1>
                                <p className="text-xs text-slate-400 mt-1">Weekly & Monthly Report</p>
                            </div>
                            <nav className="px-3 py-6 flex-1 overflow-x-auto md:overflow-visible flex md:block gap-2 no-scrollbar">
                                <NavItem active={activeTab === 'dashboard'} onClick={() => {setActiveTab('dashboard'); setEditingEntry(null);}} icon={<LayoutDashboard size={20} />} label="Dashboard" themeColor={settings.themeColor} />
                                <NavItem active={activeTab === 'add'} onClick={() => setActiveTab('add')} icon={<PlusCircle size={20} />} label={editingEntry ? "Edit Entry" : "Add Entry"} themeColor={settings.themeColor} />
                                <NavItem active={activeTab === 'monthly'} onClick={() => {setActiveTab('monthly'); setEditingEntry(null);}} icon={<Calendar size={20} />} label="Monthly Report" themeColor={settings.themeColor} />
                                <NavItem active={activeTab === 'records'} onClick={() => {setActiveTab('records'); setEditingEntry(null);}} icon={<FileText size={20} />} label="All Records" themeColor={settings.themeColor} />
                                <div className="md:mt-auto md:border-t md:border-slate-800 md:pt-4">
                                    <NavItem active={activeTab === 'settings'} onClick={() => {setActiveTab('settings'); setEditingEntry(null);}} icon={<Settings size={20} />} label="Settings" themeColor={settings.themeColor} />
                                </div>
                            </nav>
                        </aside>
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen flex flex-col">
                            <div className="max-w-7xl mx-auto w-full flex-1">
                                {activeTab === 'dashboard' && <Dashboard entries={entries} themeColor={settings.themeColor} />}
                                {activeTab === 'add' && <EntryForm onSave={handleSaveEntry} onCancel={() => {setActiveTab('dashboard'); setEditingEntry(null);}} themeColor={settings.themeColor} editingEntry={editingEntry} allEntries={entries} billHistory={billHistory} onSaveBillCount={handleSaveBillCount} />}
                                {activeTab === 'monthly' && <MonthlyReport entries={entries} themeColor={settings.themeColor} onPrint={(data) => handlePrint('list', data)} />}
                                {activeTab === 'records' && <RecordsTable entries={entries} onDelete={handleDeleteEntry} onEdit={handleEditEntry} onView={setViewingEntry} onPrintSingle={(e) => handlePrint('single', e)} onPrintList={(data) => handlePrint('list', data)} themeColor={settings.themeColor} />}
                                {activeTab === 'settings' && <SettingsPage settings={settings} updateSettings={handleUpdateSettings} onClear={handleClearAll} onImport={handleImportData} entries={entries} onLogout={onLogout} />}
                            </div>
                            <footer className="mt-8 text-center text-slate-400 text-xs font-church-body py-2">
                                &copy; {new Date().getFullYear()} SHIFT. All rights reserved.
                            </footer>
                        </main>
                    </div>
                );
            };

            // --- ROOT ORCHESTRATOR ---
            const Root = () => {
                const [appState, setAppState] = useState('loading'); 
                const [splashLogo, setSplashLogo] = useState(null);

                useEffect(() => {
                    const isAuth = localStorage.getItem('shift_auth_logged_in') === 'true';
                    const splashSeen = sessionStorage.getItem('shift_splash_seen') === 'true';
                    const savedSplashLogo = localStorage.getItem('shift_splash_logo');
                    const savedSettings = localStorage.getItem('shift_app_settings');

                    if (savedSplashLogo) {
                        setSplashLogo(savedSplashLogo);
                    }
                    
                    if (savedSettings) {
                        try {
                            const s = JSON.parse(savedSettings);
                            if (s.favicon) applyFavicon(s.favicon);
                        } catch(e) {}
                    }
                    
                    if (isAuth) {
                        setAppState('app');
                    } else if (splashSeen) {
                        setAppState('login');
                    } else {
                        setAppState('splash');
                    }
                }, []);

                const handleSplashComplete = () => {
                    sessionStorage.setItem('shift_splash_seen', 'true');
                    setAppState('login');
                };

                const handleLoginSuccess = (remember) => {
                    if (remember) {
                        localStorage.setItem('shift_auth_logged_in', 'true');
                    } else {
                        localStorage.setItem('shift_auth_logged_in', 'true'); 
                    }
                    setAppState('app');
                };

                const handleLogout = () => {
                    if (confirm("Are you sure you want to sign out?")) {
                        localStorage.removeItem('shift_auth_logged_in');
                        sessionStorage.removeItem('shift_splash_seen'); // Clear "seen" flag to force splash on return
                        setAppState('splash');
                    }
                };

                if (appState === 'loading') return null; 

                return (
                    <React.Fragment>
                        {appState === 'splash' && <SplashScreen onComplete={handleSplashComplete} customLogo={splashLogo} />}
                        {appState === 'login' && <LoginPage onLogin={handleLoginSuccess} />}
                        {appState === 'app' && <DashboardApp onLogout={handleLogout} />}
                    </React.Fragment>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<Root />);
        });
    </script>
</body>

</html>
